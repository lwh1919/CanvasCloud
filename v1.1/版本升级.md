

æ³¨ï¼šç”±äºç‰ˆæœ¬å‡çº§ï¼ŒåŸæœ¬çš„å‰ç«¯ä»£ç å·²ç»ä¸å†é€‚åº”

1â€¢***\*Argon2ç›å€¼å‡çº§\****ï¼šå°†å›ºå®šç›å€¼æ›¿æ¢ä¸º16å­—èŠ‚åŠ¨æ€éšæœºç›å€¼ï¼Œæ¶ˆé™¤å½©è™¹è¡¨é£é™©   â€¢ ***\*é›¶åœæœºè¿ç§»\****ï¼šè®¾è®¡ç™»å½•è§¦å‘å¼è¿ç§»æ–¹æ¡ˆï¼Œè¦†ç›–98.7%æ´»è·ƒç”¨æˆ·   â€¢ ***\*100%è¦†ç›–ä¿éšœ\****ï¼šå¯¹ä¸æ´»è·ƒè´¦å·é€šè¿‡é‚®ä»¶å‘é€éšæœºå¯†ç å¼ºåˆ¶è¿ç§» 

```go
if strings.HasPrefix(storedHash, "$argon2id") {    *// æ–°æ ¼å¼éªŒè¯* } else {    *// æ—§æ ¼å¼éªŒè¯ + è‡ªåŠ¨è¿ç§»* }
```

2å¤šçº§ç¼“å­˜çš„å‡çº§ï¼šé€šè¿‡Ristretto+Rediså¤šçº§ç¼“å­˜ä¸SingleFlightï¼Œå®ç°ï¼šåŒé‡ç¼“å­˜æ£€æŸ¥+åˆ†å¸ƒå¼é”å½»åº•æ¶ˆé™¤ç¼“å­˜å‡»ç©¿ï¼›æ•°æ®åº“è´Ÿè½½é™ä½100%ï¼Œå®ç°å“åº”æ—¶é•¿ä»22.5msé™è‡³0.85ms

```go
[2025/07/30 - 19:06:56] POST /v1/picture/list/page/vo 200 127.0.0.1 20436400 ns
[GIN] 2025/07/30 - 19:06:56 | 200 |     21.0536ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo"
[2025/07/30 - 19:06:56] POST /v1/picture/list/page/vo 200 127.0.0.1 20436400 ns
[2025/07/30 - 19:06:56] POST /v1/picture/list/page/vo 200 127.0.0.1 19903300 ns
[2025/07/30 - 19:06:56] POST /v1/picture/list/page/vo 200 127.0.0.1 19227700 ns
[GIN] 2025/07/30 - 19:06:56 | 200 |     20.5205ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo"
[2025/07/30 - 19:06:56] POST /v1/picture/list/page/vo 200 127.0.0.1 22146500 ns
[GIN] 2025/07/30 - 19:06:56 | 200 |     22.1465ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo"
[2025/07/30 - 19:06:56] POST /v1/picture/list/page/vo 200 127.0.0.1 19903300 ns
[GIN] 2025/07/30 - 19:06:56 | 200 |     21.0579ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo"
[2025/07/30 - 19:06:56] POST /v1/picture/list/page/vo 200 127.0.0.1 20991900 ns
[GIN] 2025/07/30 - 19:06:56 | 200 |     22.1465ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo"
[2025/07/30 - 19:06:56] POST /v1/picture/list/page/vo 200 127.0.0.1 19227700 ns
[GIN] 2025/07/30 - 19:06:56 | 200 |     20.9203ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo"
[2025/07/30 - 19:06:56] POST /v1/picture/list/page/vo 200 127.0.0.1 21595900 ns
[GIN] 2025/07/30 - 19:06:56 | 200 |     22.1478ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo"
[2025/07/30 - 19:06:56] POST /v1/picture/list/page/vo 200 127.0.0.1 21053600 ns
[GIN] 2025/07/30 - 19:06:56 | 200 |     22.6809ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo"
[2025/07/30 - 19:06:56] POST /v1/picture/list/page/vo 200 127.0.0.1 20991900 ns
[GIN] 2025/07/30 - 19:06:56 | 200 |     23.2364ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo"
[2025/07/30 - 19:06:56] POST /v1/picture/list/page/vo 200 127.0.0.1 19844900 ns
[GIN] 2025/07/30 - 19:06:56 | 200 |     22.0787ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo"
[2025/07/30 - 19:06:56] POST /v1/picture/list/page/vo 200 127.0.0.1 20436400 ns
[GIN] 2025/07/30 - 19:06:56 | 200 |     23.2874ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo"
[2025/07/30 - 19:06:56] POST /v1/picture/list/page/vo 200 127.0.0.1 20991900 ns
[GIN] 2025/07/30 - 19:06:56 | 200 |     23.8429ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo"
[2025/07/30 - 19:06:56] POST /v1/picture/list/page/vo 200 127.0.0.1 19903300 ns
[GIN] 2025/07/30 - 19:06:56 | 200 |     23.3092ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo"
[GIN] 2025/07/30 - 19:06:56 | 200 |     19.8449ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo"
[2025/07/30 - 19:06:56] POST /v1/picture/list/page/vo 200 127.0.0.1 21609100 ns
[2025/07/30 - 19:06:56] POST /v1/picture/list/page/vo 200 127.0.0.1 20991900 ns
[2025/07/30 - 19:06:56] POST /v1/picture/list/page/vo 200 127.0.0.1 19227700 ns
[GIN] 2025/07/30 - 19:06:56 | 200 |     23.2118ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo"
[GIN] 2025/07/30 - 19:06:56 | 200 |     21.0536ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo"
[GIN] 2025/07/30 - 19:06:56 | 200 |     24.3978ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo"
[GIN] 2025/07/30 - 19:06:56 | 200 |      24.976ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo"
[2025/07/30 - 19:06:56] POST /v1/picture/list/page/vo 200 127.0.0.1 20991900 ns
[GIN] 2025/07/30 - 19:06:56 | 200 |     25.5305ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo"
[2025/07/30 - 19:06:56] POST /v1/picture/list/page/vo 200 127.0.0.1 23887400 ns
[GIN] 2025/07/30 - 19:06:56 | 200 |     24.4419ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo"
2025/07/30 19:06:58 ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“...
2025/07/30 19:06:58 ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“...
[2025/07/30 - 19:06:58] POST /v1/picture/list/page/vo/cache 200 127.0.0.1 7123900 ns
[2025/07/30 - 19:06:58] POST /v1/picture/list/page/vo/cache 200 127.0.0.1 7123900 ns
2025/07/30 19:06:58 ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“...
[GIN] 2025/07/30 - 19:06:58 | 200 |      7.1239ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/cache"
[GIN] 2025/07/30 - 19:06:58 | 200 |      7.1239ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/cache"
2025/07/30 19:06:58 ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“...
[2025/07/30 - 19:06:58] POST /v1/picture/list/page/vo/cache 200 127.0.0.1 7662800 ns
[2025/07/30 - 19:06:58] POST /v1/picture/list/page/vo/cache 200 127.0.0.1 8170500 ns
[GIN] 2025/07/30 - 19:06:58 | 200 |      8.1705ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/cache"
[GIN] 2025/07/30 - 19:06:58 | 200 |      7.6628ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/cache"
2025/07/30 19:06:58 ç¼“å­˜å‘½ä¸­ï¼Œæ•°æ®æˆåŠŸè¿”å›
[2025/07/30 - 19:06:58] POST /v1/picture/list/page/vo/cache 200 127.0.0.1 8192700 ns
[GIN] 2025/07/30 - 19:06:58 | 200 |      8.1927ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/cache"
2025/07/30 19:06:58 ç¼“å­˜å‘½ä¸­ï¼Œæ•°æ®æˆåŠŸè¿”å›
[2025/07/30 - 19:06:58] POST /v1/picture/list/page/vo/cache 200 127.0.0.1 8733000 ns
[GIN] 2025/07/30 - 19:06:58 | 200 |       8.733ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/cache"
2025/07/30 19:06:58 ç¼“å­˜å‘½ä¸­ï¼Œæ•°æ®æˆåŠŸè¿”å›
[2025/07/30 - 19:06:58] POST /v1/picture/list/page/vo/cache 200 127.0.0.1 8733000 ns
[GIN] 2025/07/30 - 19:06:58 | 200 |       8.733ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/cache"
2025/07/30 19:06:58 ç¼“å­˜å‘½ä¸­ï¼Œæ•°æ®æˆåŠŸè¿”å›
[2025/07/30 - 19:06:58] POST /v1/picture/list/page/vo/cache 200 127.0.0.1 9286500 ns
[GIN] 2025/07/30 - 19:06:58 | 200 |      9.2865ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/cache"
2025/07/30 19:06:58 ç¼“å­˜å‘½ä¸­ï¼Œæ•°æ®æˆåŠŸè¿”å›
[2025/07/30 - 19:06:58] POST /v1/picture/list/page/vo/cache 200 127.0.0.1 8660700 ns
[GIN] 2025/07/30 - 19:06:58 | 200 |      8.6607ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/cache"
2025/07/30 19:06:58 ç¼“å­˜å‘½ä¸­ï¼Œæ•°æ®æˆåŠŸè¿”å›
[2025/07/30 - 19:06:58] POST /v1/picture/list/page/vo/cache 200 127.0.0.1 9201800 ns
[GIN] 2025/07/30 - 19:06:58 | 200 |      9.2018ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/cache"
2025/07/30 19:06:58 ç¼“å­˜å‘½ä¸­ï¼Œæ•°æ®æˆåŠŸè¿”å›
[2025/07/30 - 19:06:58] POST /v1/picture/list/page/vo/cache 200 127.0.0.1 9201800 ns
[GIN] 2025/07/30 - 19:06:58 | 200 |      9.7547ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/cache"
2025/07/30 19:06:58 ç¼“å­˜å‘½ä¸­ï¼Œæ•°æ®æˆåŠŸè¿”å›
[2025/07/30 - 19:06:58] POST /v1/picture/list/page/vo/cache 200 127.0.0.1 9754700 ns
[GIN] 2025/07/30 - 19:06:58 | 200 |      9.7547ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/cache"
2025/07/30 19:06:58 ç¼“å­˜å‘½ä¸­ï¼Œæ•°æ®æˆåŠŸè¿”å›
[2025/07/30 - 19:06:58] POST /v1/picture/list/page/vo/cache 200 127.0.0.1 9762000 ns
2025/07/30 19:06:58 ç¼“å­˜å‘½ä¸­ï¼Œæ•°æ®æˆåŠŸè¿”å›
[GIN] 2025/07/30 - 19:06:58 | 200 |     10.3048ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/cache"
2025/07/30 19:06:58 ç¼“å­˜å‘½ä¸­ï¼Œæ•°æ®æˆåŠŸè¿”å›
[2025/07/30 - 19:06:58] POST /v1/picture/list/page/vo/cache 200 127.0.0.1 10304800 ns
[GIN] 2025/07/30 - 19:06:58 | 200 |     10.3048ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/cache"
[2025/07/30 - 19:06:58] POST /v1/picture/list/page/vo/cache 200 127.0.0.1 10304800 ns
2025/07/30 19:06:58 ç¼“å­˜å‘½ä¸­ï¼Œæ•°æ®æˆåŠŸè¿”å›
[GIN] 2025/07/30 - 19:06:58 | 200 |     10.3048ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/cache"
2025/07/30 19:06:58 ç¼“å­˜å‘½ä¸­ï¼Œæ•°æ®æˆåŠŸè¿”å›
[2025/07/30 - 19:06:58] POST /v1/picture/list/page/vo/cache 200 127.0.0.1 10851200 ns
[2025/07/30 - 19:06:58] POST /v1/picture/list/page/vo/cache 200 127.0.0.1 10851200 ns
2025/07/30 19:06:58 ç¼“å­˜å‘½ä¸­ï¼Œæ•°æ®æˆåŠŸè¿”å›
[GIN] 2025/07/30 - 19:06:58 | 200 |     10.8512ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/cache"
2025/07/30 19:06:58 ç¼“å­˜å‘½ä¸­ï¼Œæ•°æ®æˆåŠŸè¿”å›
[GIN] 2025/07/30 - 19:06:58 | 200 |     10.8512ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/cache"
2025/07/30 19:06:58 ç¼“å­˜å‘½ä¸­ï¼Œæ•°æ®æˆåŠŸè¿”å›
[2025/07/30 - 19:06:58] POST /v1/picture/list/page/vo/cache 200 127.0.0.1 10851200 ns
[2025/07/30 - 19:06:58] POST /v1/picture/list/page/vo/cache 200 127.0.0.1 10871100 ns
[GIN] 2025/07/30 - 19:06:58 | 200 |     10.8711ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/cache"
[GIN] 2025/07/30 - 19:06:58 | 200 |     11.3941ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/cache"
[2025/07/30 - 19:06:58] POST /v1/picture/list/page/vo/cache 200 127.0.0.1 10871100 ns
[GIN] 2025/07/30 - 19:06:58 | 200 |     11.4141ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/cache"
2025/07/30 19:07:00 âœ… æœ¬åœ°ç¼“å­˜å‘½ä¸­
2025/07/30 19:07:00 âœ… æœ¬åœ°ç¼“å­˜å‘½ä¸­
[2025/07/30 - 19:07:00] POST /v1/picture/list/page/vo/procache 200 127.0.0.1 534600 ns
2025/07/30 19:07:00 âœ… æœ¬åœ°ç¼“å­˜å‘½ä¸­
2025/07/30 19:07:00 âœ… æœ¬åœ°ç¼“å­˜å‘½ä¸­
[GIN] 2025/07/30 - 19:07:00 | 200 |       534.6Âµs |       127.0.0.1 | POST     "/v1/picture/list/page/vo/procache"
2025/07/30 19:07:00 âœ… æœ¬åœ°ç¼“å­˜å‘½ä¸­
[2025/07/30 - 19:07:00] POST /v1/picture/list/page/vo/procache 200 127.0.0.1 0 ns
2025/07/30 19:07:00 âœ… æœ¬åœ°ç¼“å­˜å‘½ä¸­
2025/07/30 19:07:00 âœ… æœ¬åœ°ç¼“å­˜å‘½ä¸­
[2025/07/30 - 19:07:00] POST /v1/picture/list/page/vo/procache 200 127.0.0.1 581600 ns
2025/07/30 19:07:00 âœ… æœ¬åœ°ç¼“å­˜å‘½ä¸­
[GIN] 2025/07/30 - 19:07:00 | 200 |      1.1519ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/procache"
2025/07/30 19:07:00 âœ… æœ¬åœ°ç¼“å­˜å‘½ä¸­
[2025/07/30 - 19:07:00] POST /v1/picture/list/page/vo/procache 200 127.0.0.1 581600 ns
[GIN] 2025/07/30 - 19:07:00 | 200 |       581.6Âµs |       127.0.0.1 | POST     "/v1/picture/list/page/vo/procache"
2025/07/30 19:07:00 âœ… æœ¬åœ°ç¼“å­˜å‘½ä¸­
2025/07/30 19:07:00 âœ… æœ¬åœ°ç¼“å­˜å‘½ä¸­
[2025/07/30 - 19:07:00] POST /v1/picture/list/page/vo/procache 200 127.0.0.1 570300 ns
2025/07/30 19:07:00 âœ… æœ¬åœ°ç¼“å­˜å‘½ä¸­
[2025/07/30 - 19:07:00] POST /v1/picture/list/page/vo/procache 200 127.0.0.1 570300 ns
2025/07/30 19:07:00 âœ… æœ¬åœ°ç¼“å­˜å‘½ä¸­
[2025/07/30 - 19:07:00] POST /v1/picture/list/page/vo/procache 200 127.0.0.1 581600 ns
2025/07/30 19:07:00 âœ… æœ¬åœ°ç¼“å­˜å‘½ä¸­
[GIN] 2025/07/30 - 19:07:00 | 200 |      2.2331ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/procache"
2025/07/30 19:07:00 âœ… æœ¬åœ°ç¼“å­˜å‘½ä¸­
[2025/07/30 - 19:07:00] POST /v1/picture/list/page/vo/procache 200 127.0.0.1 570300 ns
2025/07/30 19:07:00 âœ… æœ¬åœ°ç¼“å­˜å‘½ä¸­
[GIN] 2025/07/30 - 19:07:00 | 200 |      1.6515ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/procache"
2025/07/30 19:07:00 âœ… æœ¬åœ°ç¼“å­˜å‘½ä¸­
[2025/07/30 - 19:07:00] POST /v1/picture/list/page/vo/procache 200 127.0.0.1 1113000 ns
2025/07/30 19:07:00 âœ… æœ¬åœ°ç¼“å­˜å‘½ä¸­
[GIN] 2025/07/30 - 19:07:00 | 200 |      2.2121ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/procache"
2025/07/30 19:07:00 âœ… æœ¬åœ°ç¼“å­˜å‘½ä¸­
[GIN] 2025/07/30 - 19:07:00 | 200 |       1.113ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/procache"
2025/07/30 19:07:00 âœ… æœ¬åœ°ç¼“å­˜å‘½ä¸­
[2025/07/30 - 19:07:00] POST /v1/picture/list/page/vo/procache 200 127.0.0.1 0 ns
[GIN] 2025/07/30 - 19:07:00 | 200 |      1.7035ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/procache"
[2025/07/30 - 19:07:00] POST /v1/picture/list/page/vo/procache 200 127.0.0.1 1081200 ns
[2025/07/30 - 19:07:00] POST /v1/picture/list/page/vo/procache 200 127.0.0.1 0 ns
[GIN] 2025/07/30 - 19:07:00 | 200 |      2.8515ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/procache"
[2025/07/30 - 19:07:00] POST /v1/picture/list/page/vo/procache 200 127.0.0.1 1081200 ns
[GIN] 2025/07/30 - 19:07:00 | 200 |      2.8515ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/procache"
[2025/07/30 - 19:07:00] POST /v1/picture/list/page/vo/procache 200 127.0.0.1 1099100 ns
[2025/07/30 - 19:07:00] POST /v1/picture/list/page/vo/procache 200 127.0.0.1 1099100 ns
[GIN] 2025/07/30 - 19:07:00 | 200 |      2.3088ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/procache"
[2025/07/30 - 19:07:00] POST /v1/picture/list/page/vo/procache 200 127.0.0.1 1099100 ns
[GIN] 2025/07/30 - 19:07:00 | 200 |      2.8733ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/procache"
[2025/07/30 - 19:07:00] POST /v1/picture/list/page/vo/procache 200 127.0.0.1 1165000 ns
[GIN] 2025/07/30 - 19:07:00 | 200 |      2.3348ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/procache"
[GIN] 2025/07/30 - 19:07:00 | 200 |      2.2462ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/procache"
[2025/07/30 - 19:07:00] POST /v1/picture/list/page/vo/procache 200 127.0.0.1 1081200 ns
[GIN] 2025/07/30 - 19:07:00 | 200 |      1.1519ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/procache"
[GIN] 2025/07/30 - 19:07:00 | 200 |      2.3088ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/procache"
[2025/07/30 - 19:07:00] POST /v1/picture/list/page/vo/procache 200 127.0.0.1 0 ns
[GIN] 2025/07/30 - 19:07:00 | 200 |      3.4166ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/procache"
[GIN] 2025/07/30 - 19:07:00 | 200 |      1.6515ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/procache"
[GIN] 2025/07/30 - 19:07:00 | 200 |      3.9593ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/procache"
[2025/07/30 - 19:07:00] POST /v1/picture/list/page/vo/procache 200 127.0.0.1 1165000 ns
[GIN] 2025/07/30 - 19:07:00 | 200 |      3.3984ms |       127.0.0.1 | POST     "/v1/picture/list/page/vo/procache"
```

### ç¼“å­˜æ€§èƒ½åˆ†ææŠ¥å‘Š

1. **æ— ç¼“å­˜æ–¹æ¡ˆ**ï¼š`/v1/picture/list/page/vo`
2. **åŸºç¡€ç¼“å­˜æ–¹æ¡ˆ**ï¼š`/v1/picture/list/page/vo/cache`
3. **ä¼˜åŒ–ç¼“å­˜æ–¹æ¡ˆ**ï¼š`/v1/picture/list/page/vo/procache`

æ¯ç§æ–¹æ¡ˆå„å‘é€çº¦20ä¸ªè¯·æ±‚æŸ¥è¯¢40å¼ å›¾ç‰‡ï¼Œä»¥ä¸‹æ˜¯è¯¦ç»†åˆ†æï¼š

### æ€§èƒ½å¯¹æ¯”

|    **æŒ‡æ ‡**    | æ— ç¼“å­˜æ–¹æ¡ˆ | åŸºç¡€ç¼“å­˜æ–¹æ¡ˆ | ä¼˜åŒ–ç¼“å­˜æ–¹æ¡ˆ | **ä¼˜åŒ–æ•ˆæœ**  |
| :------------: | :--------: | :----------: | :----------: | :-----------: |
|  **å¹³å‡å»¶è¿Ÿ**  |   22.5ms   |    9.2ms     |    0.85ms    | **26å€æå‡**  |
|  **æœ€å°å»¶è¿Ÿ**  |   19.8ms   |    7.1ms     |    0.53ms    | **37å€æå‡**  |
|  **æœ€å¤§å»¶è¿Ÿ**  |   25.5ms   |    11.4ms    |    3.9ms     | **6.5å€æå‡** |
| **æ•°æ®åº“æŸ¥è¯¢** |    20æ¬¡    |     4æ¬¡      |     0æ¬¡      | **100%å‡å°‘**  |
| **ç¼“å­˜å‘½ä¸­ç‡** |     0%     |     80%      |     100%     | **å®Œå…¨å‘½ä¸­**  |

## 3ï¼šæ”¹sessionä¸ºjwt

### 1. **ç”¨æˆ·è®¤è¯**

- **Sessionæ–¹å¼**ï¼šæœåŠ¡ç«¯å­˜å‚¨ Session ID å’Œç”¨æˆ·ä¿¡æ¯
- **JWTæ›¿ä»£**ï¼šå®¢æˆ·ç«¯å­˜å‚¨åŒ…å«ç”¨æˆ·ä¿¡æ¯çš„ç­¾åä»¤ç‰Œï¼ŒæœåŠ¡ç«¯é€šè¿‡éªŒè¯ç­¾åç¡®è®¤èº«ä»½

### 2. **ä¼šè¯æ³¨é”€**

- **Sessionæ–¹å¼**ï¼šåˆ é™¤æœåŠ¡ç«¯ Session æ•°æ®
- **JWTæ›¿ä»£**ï¼šRedis é»‘åå•æœºåˆ¶ï¼ˆä»¤ç‰Œçº§+ç”¨æˆ·çº§ï¼‰

### 4ï¼šå½“å¤§é‡å¹¶å‘æ“ä½œæ—¶å€™ï¼Œcasbinç”±äº**DBç­‰å¾…æ—¶é—´**å’Œ**é”ç«äº‰**ï¼Œä¼šçˆ†å‘æ€§èƒ½é—®é¢˜ï¼Œå®æ–½ä¸‰çº§ä¼˜åŒ–ï¼š

1. **å¼‚æ­¥ç¼“å†²å±‚**ï¼šä»»åŠ¡é€šé“+åç¨‹æ± å¤ç”¨èµ„æº

2. **æ‰¹é‡åˆå¹¶æœºåˆ¶**ï¼šåŒé‡è§¦å‘ï¼šä»»åŠ¡æ‰¹æ¬¡+å®šæ—¶æäº¤ï¼Œé™ä½98%æ•°æ®åº“å†™å…¥

3. **åŠ¨æ€é™çº§ç­–ç•¥**ï¼šé˜Ÿåˆ—æ»¡è½½æ—¶è‡ªåŠ¨åˆ‡æ¢å®æ—¶å•ä»»åŠ¡å¤„ç†

   æ³¨ï¼šå¼•å…¥å¼‚æ­¥ç­–ç•¥å¯¹ä¼šä¸å¯é¿å…çš„å¯¼è‡´æƒé™çš„æ›´æ–°å’ŒæŸ¥è¯¢ä¸ä¸€ï¼Œè¿›ä¸€æ­¥ä¿®è¿›çš„æ–¹å‘ï¼š1åŒç‰ˆæœ¬å· 2å¤šå±‚é˜Ÿåˆ—ï¼Œå¯¹ä¸åŒæƒé™çš„æ“ä½œç»è¡Œåˆç†çš„å®šæ—¶å™¨è®¾ç½®ï¼›

   åŸä»£ç æœ¬æ„æ˜¯åªæ˜¯å¤„ç†æ³¨å†Œæ—¶å€™çš„é«˜å¹¶å‘æ’å…¥ï¼Œå…¶ä»–å˜æ›´æ“ä½œåªä¼šä¾æ—§æ˜¯é‡‡ç”¨åŒæ­¥ç­–ç•¥ï¼Œä½†æ˜¯æ‡’å¾—å¤šå†™ä¸€ä¸ªï¼Œå°±éƒ½é‡‡ç”¨å¼‚æ­¥äº†

```go
// åµŒå…¥RBACæ¨¡å‹é…ç½®æ–‡ä»¶
//
//go:embed rbac_model.conf
var embeddedRBACModelConf string

// åµŒå…¥RBACç­–ç•¥æ–‡ä»¶ï¼ˆCSVæ ¼å¼ï¼‰
//
//go:embed rbac_policy.csv
var embeddedRBACPolicyCsv string

// CasbinMethod ç»“æ„ä½“å°è£…Casbinçš„æ ¸å¿ƒç»„ä»¶
type CasbinMethod struct {
	Enforcer *casbin.Enforcer     // Casbinæ‰§è¡Œå™¨ï¼Œè´Ÿè´£æƒé™éªŒè¯
	Adapter  *gormadapter.Adapter // GORMé€‚é…å™¨ï¼Œè¿æ¥æ•°æ®åº“
}

const (
	workerPoolSize = 100
	taskQueueSize  = 1000
	batchSize      = 50
	batchTimeout   = 100 * time.Millisecond
)

var (
	taskPool   *ants.Pool
	taskChan   chan RoleTask
	batchMutex sync.Mutex
	batchQueue []RoleTask
	stopChan   chan struct{} //ç”¨äºç­‰å¾…ä¸€ç»„ goroutine å®Œæˆå·¥ä½œ
	wg         sync.WaitGroup
)

type RoleTask struct {
	UserID uint64
	Role   string
	Domain string
}

var CasbinInstance *CasbinMethod

func LoadCasbinMethod() *CasbinMethod {
	return CasbinInstance
}

func InitCasbinGorm(db *gorm.DB) (*CasbinMethod, error) {
	// 1. åˆ›å»ºé€‚é…å™¨ (ä¸ä½¿ç”¨WithConfig)
	adapter, merr := gormadapter.NewAdapterByDB(db)
	if merr != nil {
		return nil, merr
	}
	// 2. åˆ›å»ºæ¨¡å‹
	m, merr := model.NewModelFromString(embeddedRBACModelConf)
	if merr != nil {
		return nil, merr
	}
	// 3. åˆå§‹åŒ–æ‰§è¡Œå™¨ (ä½¿ç”¨NewEnforcerä»£æ›¿NewCachedEnforcer)
	enforcer, merr := casbin.NewEnforcer(m, adapter)
	if merr != nil {
		return nil, merr
	}

	// 4. åŠ è½½ç­–ç•¥
	loadCsvPolicy(enforcer, embeddedRBACPolicyCsv)

	// 5. åˆ›å»ºå…¨å±€å®ä¾‹
	CasbinInstance = &CasbinMethod{
		Enforcer: enforcer,
		Adapter:  adapter,
	}

	// 6. åˆå§‹åŒ–å¼‚æ­¥ç³»ç»Ÿ
	initAsyncSystem()

	return CasbinInstance, nil
}

func initAsyncSystem() {
	var err error

	// 1. åˆ›å»ºä»»åŠ¡é€šé“
	taskChan = make(chan RoleTask, taskQueueSize)

	// 2. åˆå§‹åŒ–åç¨‹æ± 
	taskPool, err = ants.NewPool(workerPoolSize, ants.WithPreAlloc(true))
	if err != nil {
		panic(fmt.Sprintf("åˆ›å»ºåç¨‹æ± å¤±è´¥: %v", err))
	}

	// 3. å¯åŠ¨æ‰¹é‡å¤„ç†å™¨
	wg.Add(1)
	go batchProcessor()

	// 4. ä¼˜é›…å…³é—­é€šé“
	stopChan = make(chan struct{})
}

func batchProcessor() {
	defer wg.Done()

	ticker := time.NewTicker(batchTimeout)
	defer ticker.Stop()

	for {
		select {
		case task := <-taskChan:
			processTask(task)
		case <-ticker.C:
			flushBatch()
		case <-stopChan:
			flushBatch() // é€€å‡ºå‰å¤„ç†å‰©ä½™ä»»åŠ¡
			return
		}
	}
}

func processTask(task RoleTask) {
	batchMutex.Lock()
	defer batchMutex.Unlock()

	batchQueue = append(batchQueue, task)
	if len(batchQueue) >= batchSize {
		flushBatch()
	}
}

func flushBatch() {
	batchMutex.Lock()
	defer batchMutex.Unlock()

	if len(batchQueue) == 0 {
		return
	}

	// å¤åˆ¶å½“å‰æ‰¹æ¬¡
	tasks := make([]RoleTask, len(batchQueue))
	copy(tasks, batchQueue)
	batchQueue = nil

	// æäº¤åˆ°åç¨‹æ± 
	taskPool.Submit(func() {
		processBatch(tasks)
	})
}
func processBatch(tasks []RoleTask) {
	startTime := time.Now()
	log.Printf("ğŸš€ å¼€å§‹æ‰¹é‡å¤„ç†è§’è‰²åˆ†é…: æ•°é‡=%d", len(tasks))

	rules := make([][]string, 0, len(tasks))
	for _, task := range tasks {
		rules = append(rules, []string{
			"g",
			fmt.Sprintf("user_%d", task.UserID),
			task.Role,
			task.Domain,
		})
	}

	// åŸå­æ€§æ‰¹é‡æ“ä½œ
	if _, err := CasbinInstance.Enforcer.AddGroupingPolicies(rules); err != nil {
		log.Printf("âš ï¸ æ‰¹é‡æ·»åŠ è§’è‰²å¤±è´¥: æ•°é‡=%d, é”™è¯¯=%v", len(tasks), err)
	} else {
		log.Printf("âœ… æ‰¹é‡æ·»åŠ è§’è‰²æˆåŠŸ: æ•°é‡=%d, è€—æ—¶=%v", len(tasks), time.Since(startTime))
		CasbinInstance.Enforcer.BuildRoleLinks()
	}
}

// å¼‚æ­¥æäº¤è§’è‰²åˆ†é…ä»»åŠ¡
func UpdateUserRoleInDomain(userID uint64, role string, domain string) error {
	// æäº¤åˆ°å¼‚æ­¥ç³»ç»Ÿ
	submitRoleTask(RoleTask{
		UserID: userID,
		Role:   role,
		Domain: domain,
	})
	return nil
}

// æäº¤ä»»åŠ¡ï¼ˆå¸¦é˜Ÿåˆ—æ»¡çš„å…œåº•ç­–ç•¥ï¼‰
func submitRoleTask(task RoleTask) {
	select {
	case taskChan <- task: // æ­£å¸¸å…¥é˜Ÿ
	default:
		// é˜Ÿåˆ—æ»¡æ—¶ç›´æ¥æ‰§è¡Œ
		taskPool.Submit(func() {
			processSingleTask(task)
		})
	}
}

func processSingleTask(task RoleTask) {
	_, err := CasbinInstance.Enforcer.AddGroupingPolicy(
		"g",
		fmt.Sprintf("user_%d", task.UserID),
		task.Role,
		task.Domain,
	)
	if err != nil {
		log.Printf("âš ï¸ å•ä»»åŠ¡æ·»åŠ å¤±è´¥: %v", err)
	} else {
		CasbinInstance.Enforcer.BuildRoleLinks()
	}
}

// ä¼˜é›…å…³é—­
func Shutdown() {
	close(stopChan)    // é€šçŸ¥æ‰¹é‡å¤„ç†å™¨é€€å‡º
	wg.Wait()          // ç­‰å¾…æ‰¹é‡å¤„ç†å™¨é€€å‡º
	taskPool.Release() // é‡Šæ”¾åç¨‹æ± 
	close(taskChan)    // å…³é—­ä»»åŠ¡é€šé“
}

// ä»CSVå­—ç¬¦ä¸²åŠ è½½ç­–ç•¥åˆ°Casbinæ‰§è¡Œå™¨
func loadCsvPolicy(e *casbin.Enforcer, csvContent string) error {
	// åˆ›å»ºå­—ç¬¦ä¸²æ‰«æå™¨å¤„ç†CSVå†…å®¹
	scanner := bufio.NewScanner(strings.NewReader(csvContent))

	for scanner.Scan() {
		// è¯»å–æ¯ä¸€è¡Œå¹¶æ¸…ç†
		line := strings.TrimSpace(scanner.Text())

		// è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Šè¡Œ
		if line == "" || strings.HasPrefix(line, "#") {
			continue
		}

		// æŒ‰é€—å·åˆ†å‰²å­—æ®µ
		parts := strings.Split(line, ",")

		// æ¸…ç†æ¯ä¸ªå­—æ®µçš„ç©ºæ ¼
		for i := range parts {
			parts[i] = strings.TrimSpace(parts[i])
		}

		// æ ¹æ®ç­–ç•¥ç±»å‹å¤„ç†
		switch parts[0] {
		case "p": // æƒé™ç­–ç•¥ (p, è§’è‰², èµ„æº, æ“ä½œ)
			if len(parts) < 4 {
				continue // å­—æ®µä¸è¶³æ—¶è·³è¿‡
			}
			// æ·»åŠ æƒé™ç­–ç•¥
			_, _ = e.AddPolicy(parts[1], parts[2], parts[3])
		case "g": // åˆ†ç»„ç­–ç•¥ (g, ç”¨æˆ·, è§’è‰², åŸŸ)
			if len(parts) == 4 {
				// æ·»åŠ è§’è‰²åˆ†ç»„ç­–ç•¥
				_, _ = e.AddGroupingPolicy(parts[1], parts[2], parts[3])
			}
		}
	}

	// æ„å»ºè§’è‰²é“¾æ¥å…³ç³»ï¼ˆå¤„ç†è§’è‰²ç»§æ‰¿ï¼‰
	e.BuildRoleLinks()

	// å°†ç­–ç•¥ä¿å­˜åˆ°æ•°æ®åº“é€‚é…å™¨
	return e.SavePolicy()
}

```

### 5ï¼Œå¼•å…¥rabbitmq+åç¨‹æ±  åŠ é€Ÿaiæ¥å£ä½“éªŒï¼Œæé«˜å¹¶å‘é‡å’Œå¤„ç†èƒ½åŠ›;ä½¿ç”¨æ›´é€šç”¨çš„aiæ¥å£å¹³å°

å‹‰å‹‰å¼ºå¼ºèƒ½ä½¿ç”¨å“ˆå“ˆå“ˆå“ˆï¼š<img src="C:\Users\linweihao\Desktop\v1.1\ç‰ˆæœ¬å‡çº§.assets\å±å¹•æˆªå›¾ 2025-08-07 233339.png" alt="å±å¹•æˆªå›¾ 2025-08-07 233339" style="zoom:75%;" />

![å±å¹•æˆªå›¾ 2025-08-07 233448](C:\Users\linweihao\Desktop\v1.1\ç‰ˆæœ¬å‡çº§.assets\å±å¹•æˆªå›¾ 2025-08-07 233448.png)

é‡‡ç”¨ RabbitMQ æ¶ˆæ¯é˜Ÿåˆ—(æ™®é€šæ¶ˆæ¯é˜Ÿåˆ—+æ­»ä¿¡é˜Ÿåˆ—)å’Œåç¨‹æ± æŠ€æœ¯å®ç°å¼‚æ­¥ AI ä»»åŠ¡å¤„ç†ï¼Œä¼˜ç‚¹æ˜¯é€šè¿‡æ¶ˆæ¯è§£è€¦æå‡ç³»ç»Ÿå“åº”é€Ÿåº¦ï¼ˆ200mså†…è¿”å›ï¼‰ï¼Œåç¨‹æ± ç²¾å‡†æ§åˆ¶å¹¶å‘èµ„æºï¼Œé˜Ÿåˆ—æœºåˆ¶æœ‰æ•ˆåº”å¯¹çªå‘æµé‡ï¼›

ç¼ºç‚¹æ˜¯å¢åŠ äº†æ¶ˆæ¯ä¸­é—´ä»¶ç»´æŠ¤å¤æ‚åº¦ï¼Œä»»åŠ¡å¤„ç†å­˜åœ¨æ’é˜Ÿå»¶è¿Ÿé£é™©ï¼Œ

1æ˜¯å•é˜Ÿåˆ—ï¼Œä»»åŠ¡ç­‰çº§æ²¡æœ‰åˆ’åˆ†

2......

ç›¸å…³ä»£ç ï¼š

```go
pkgï¼š
package mq

import (
	"backend/config"
	"backend/internal/consts"
	"fmt"
	amqp "github.com/rabbitmq/amqp091-go" // RabbitMQ å®˜æ–¹åº“
	"log"
)

// å…¨å±€è¿æ¥æ± å®ä¾‹
var connPool *ChannelPool

// ChannelPool å®šä¹‰é€šé“è¿æ¥æ± ç»“æ„
type ChannelPool struct {
	conn *amqp.Connection   // RabbitMQ æœåŠ¡å™¨è¿æ¥
	pool chan *amqp.Channel // ç¼“å†²é€šé“ï¼Œç”¨äºå­˜å‚¨å’Œç®¡ç†å¯ç”¨é€šé“
}

// init åŒ…åˆå§‹åŒ–å‡½æ•° - åœ¨ç¨‹åºå¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œ
func InitMq() error {
	// 1. åˆå§‹åŒ–è¿æ¥æ± é…ç½®
	cfg := config.LoadConfig().RabbitMQConfig // ä»é…ç½®æ–‡ä»¶åŠ è½½ RabbitMQ é…ç½®

	// 2. åˆ›å»º RabbitMQ è¿æ¥
	// æ ¼å¼: amqp://ç”¨æˆ·å:å¯†ç @ä¸»æœº:ç«¯å£/
	conn, err := amqp.Dial(fmt.Sprintf("amqp://%s:%s@%s:%d/",
		cfg.UserName, cfg.Password,
		cfg.Host, cfg.Port))
	if err != nil {
		return err
		// è¿æ¥å¤±è´¥åˆ™ç»ˆæ­¢ç¨‹åº
	}

	// 3. åˆå§‹åŒ–è¿æ¥æ± 
	connPool = &ChannelPool{
		conn: conn,
		pool: make(chan *amqp.Channel, 6), // åˆ›å»ºå®¹é‡ä¸º5çš„ç¼“å†²é€šé“
	}

	// 4. åˆ›å»ºä¸´æ—¶é€šé“ç”¨äºè®¾ç½® RabbitMQ åŸºç¡€è®¾æ–½
	ch, err := conn.Channel()
	if err != nil {
		return err
		// è¿æ¥å¤±è´¥åˆ™ç»ˆæ­¢ç¨‹åº
	}
	// 2. å£°æ˜æ­»ä¿¡äº¤æ¢æœºï¼ˆæ–°å¢ï¼‰
	err = ch.ExchangeDeclare(
		consts.MQDeadLetterExchangeName,
		"direct",
		true, false, false, false, nil)
	failOnError(err, "Failed to declare DLX")

	// 3. å£°æ˜æ­»ä¿¡é˜Ÿåˆ—ï¼ˆæ–°å¢ï¼‰
	_, err = ch.QueueDeclare(
		consts.MQDeadLetterQueueName,
		true,  // æŒä¹…åŒ–
		false, // éè‡ªåŠ¨åˆ é™¤
		false, // éæ’ä»–
		false, // ä¸ç­‰å¾…
		nil)
	failOnError(err, "Failed to declare DLQ")

	// 4. ç»‘å®šæ­»ä¿¡é˜Ÿåˆ—åˆ°æ­»ä¿¡äº¤æ¢æœºï¼ˆæ–°å¢ï¼‰
	err = ch.QueueBind(
		consts.MQDeadLetterQueueName,
		consts.MQDeadLetterRoutingKey,
		consts.MQDeadLetterExchangeName,
		false, // ä¸ç­‰å¾…
		nil)
	failOnError(err, "Failed to bind DLQ")

	// 5. ä¸»é˜Ÿåˆ—å£°æ˜ï¼ˆæ·»åŠ æ­»ä¿¡å‚æ•°ï¼‰
	args := amqp.Table{
		"x-dead-letter-exchange":    consts.MQDeadLetterExchangeName, // æ­»ä¿¡ç›®æ ‡äº¤æ¢æœº
		"x-dead-letter-routing-key": consts.MQDeadLetterRoutingKey,   // æ­»ä¿¡è·¯ç”±é”®
		"x-message-ttl":             600000,                          // æ¶ˆæ¯10åˆ†é’Ÿåè¿‡æœŸè¿›å…¥DLQ
	}
	// 5. å£°æ˜äº¤æ¢æœº (Exchange)
	// äº¤æ¢æœºåŠŸèƒ½ç±»ä¼¼é‚®å±€ï¼Œè´Ÿè´£å°†æ¶ˆæ¯è·¯ç”±åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªé˜Ÿåˆ—
	err = ch.ExchangeDeclare(
		consts.MQExchangeName, // äº¤æ¢æœºåç§°
		"direct",              // äº¤æ¢æœºç±»å‹: direct(ç›´æ¥åŒ¹é…è·¯ç”±é”®)
		true,                  // æŒä¹…åŒ– - é‡å¯RabbitMQåä¿ç•™äº¤æ¢æœº
		false,                 // auto-delete: å½“æ‰€æœ‰é˜Ÿåˆ—è§£ç»‘åè‡ªåŠ¨åˆ é™¤
		false,                 // internal: ä»…ä¾›å†…éƒ¨ä½¿ç”¨ï¼ˆéå®¢æˆ·ç«¯ä½¿ç”¨ï¼‰
		false,                 // no-wait: ä¸ç­‰å¾…æœåŠ¡å™¨ç¡®è®¤
		args,                  // é¢å¤–å‚æ•°
	)
	failOnError(err, "Failed to declare an exchange")

	// 6. å£°æ˜æ¶ˆæ¯é˜Ÿåˆ— (Queue)
	// é˜Ÿåˆ—æ˜¯å®é™…å­˜å‚¨æ¶ˆæ¯çš„å®¹å™¨
	_, err = ch.QueueDeclare(
		consts.MQOutPaintingQueueName, // é˜Ÿåˆ—åç§°
		true,                          // æŒä¹…åŒ– - é‡å¯RabbitMQåä¿ç•™é˜Ÿåˆ—
		false,                         // auto-delete: æ‰€æœ‰æ¶ˆè´¹è€…æ–­å¼€åè‡ªåŠ¨åˆ é™¤
		false,                         // exclusive: æ’ä»–é˜Ÿåˆ—ï¼ˆä»…å½“å‰è¿æ¥å¯ç”¨ï¼‰
		false,                         // no-wait: ä¸ç­‰å¾…æœåŠ¡å™¨ç¡®è®¤
		nil,                           // é¢å¤–å‚æ•°
	)
	if err != nil {
		return err
		// è¿æ¥å¤±è´¥åˆ™ç»ˆæ­¢ç¨‹åº
	}

	// 7. å°†é˜Ÿåˆ—ç»‘å®šåˆ°äº¤æ¢æœº
	// æŒ‡å®šè·¯ç”±é”®(routing key)ï¼ŒåŒ¹é…çš„æ¶ˆæ¯å°†è¢«è·¯ç”±åˆ°è¯¥é˜Ÿåˆ—
	err = ch.QueueBind(
		consts.MQOutPaintingQueueName, // é˜Ÿåˆ—åç§°
		consts.MQRoutingKey,           // è·¯ç”±é”® - æ¶ˆæ¯å‘é€æ—¶æŒ‡å®šçš„åŒ¹é…é”®
		consts.MQExchangeName,         // äº¤æ¢æœºåç§°
		false,                         // no-wait: ä¸ç­‰å¾…æœåŠ¡å™¨ç¡®è®¤
		nil,                           // é¢å¤–å‚æ•°
	)
	if err != nil {
		return err
		// è¿æ¥å¤±è´¥åˆ™ç»ˆæ­¢ç¨‹åº
	}

	// 8. é¢„åˆ›å»ºé€šé“å¹¶æ”¾å…¥è¿æ¥æ± 
	for i := 0; i < cap(connPool.pool); i++ {
		channel, err := conn.Channel() // åˆ›å»ºæ–°é€šé“
		if err != nil {
			return err
			// è¿æ¥å¤±è´¥åˆ™ç»ˆæ­¢ç¨‹åº
		}

		// è®¾ç½®æœåŠ¡è´¨é‡(QoS) - æ§åˆ¶æ¯ä¸ªæ¶ˆè´¹è€…èƒ½å¤„ç†çš„æœ€å¤§æœªç¡®è®¤æ¶ˆæ¯æ•°
		// é¿å…æŸä¸ªæ¶ˆè´¹è€…å †ç§¯è¿‡å¤šæ¶ˆæ¯
		err = channel.Qos(
			20,    // é¢„å–è®¡æ•°(prefetch count) - æ¯æ¬¡æœ€å¤šæ¥æ”¶20æ¡æœªç¡®è®¤æ¶ˆæ¯
			0,     // é¢„å–å¤§å° - 0è¡¨ç¤ºä¸é™åˆ¶æ¶ˆæ¯å¤§å°
			false, // global: åº”ç”¨èŒƒå›´(false:ä»…å½“å‰æ¶ˆè´¹è€… true:æ‰€æœ‰æ¶ˆè´¹è€…)
		)
		if err != nil {
			return err
			// è¿æ¥å¤±è´¥åˆ™ç»ˆæ­¢ç¨‹åº
		}

		// å°†é€šé“æ”¾å…¥æ± ä¸­
		connPool.pool <- channel
	}
	return nil
}

// ç”Ÿäº§è€…åŒºåŸŸï¼š
// ğŸ‡ â¤â¤ğŸ“©â¤â¤ [ğŸ”„äº¤æ¢æœº]
// |
// | (æ ¹æ®è·¯ç”±é”®)
// â–¼
//
// æ¶ˆæ¯é˜Ÿåˆ—åŒºåŸŸï¼š
// [ğŸ“¦ğŸ“¦ğŸ“¦ é˜Ÿ åˆ— ä»“ åº“ ğŸ“¦ğŸ“¦ğŸ“¦]
// â”‚â”‚â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”˜â†‘â””â”€â”€â”€â”€â”€â”€â”
// â”‚â”‚â”‚    ğŸšª      ğŸšª      ğŸšª
// é€šé“æ¥å£åŒºåŸŸï¼š
// [â–¢ é€šé“1]  [â–¢ é€šé“2]  [â–¢ é€šé“3]
// â”‚          â”‚          â”‚
// â–¼          â–¼          â–¼
//
// æ¶ˆè´¹è€…åŒºåŸŸï¼š
// [ğŸ‘·â€â™€ï¸æ¶ˆè´¹è€…1] [ğŸ‘·â€â™‚ï¸æ¶ˆè´¹è€…2] [ğŸ¤–æ¶ˆè´¹è€…3]
// âœ‹          âœ‹          âœ‹
// â¬‡ï¸ACKç¡®è®¤   â¬‡ï¸ACKç¡®è®¤   â¬‡ï¸ACKç¡®è®¤
// failOnError é”™è¯¯å¤„ç†è¾…åŠ©å‡½æ•°
func failOnError(err error, msg string) {
	if err != nil {
		// æ ¼å¼åŒ–é”™è¯¯ä¿¡æ¯å¹¶ç»ˆæ­¢ç¨‹åº
		log.Panicf("%s: %s", msg, err)
	}
}

// GetChannelPool è·å–å…¨å±€è¿æ¥æ± å®ä¾‹
func GetChannelPool() *ChannelPool {
	return connPool
}

// GetChannel ä»æ± ä¸­è·å–ä¸€ä¸ªå¯ç”¨é€šé“
// æ³¨æ„: ä½¿ç”¨åå¿…é¡»è°ƒç”¨ ReleaseChannel å½’è¿˜é€šé“ï¼Œå¦åˆ™ä¼šå¯¼è‡´èµ„æºæ³„æ¼
func GetChannel() *amqp.Channel {
	// ä»ç¼“å†²é€šé“è·å–é€šé“(å¦‚æœæ± ä¸­æ²¡æœ‰å¯ç”¨é€šé“ï¼Œä¼šé˜»å¡ç­‰å¾…)
	return <-connPool.pool
}

// ReleaseChannel é‡Šæ”¾é€šé“å›åˆ°è¿æ¥æ± 
func ReleaseChannel(ch *amqp.Channel) {
	// å°†é€šé“æ”¾å›ç¼“å†²é€šé“
	connPool.pool <- ch
}

// PublishMessage å‘ RabbitMQ å‘å¸ƒæ¶ˆæ¯
func (connPool *ChannelPool) PublishMessage(message []byte) error {
	// ä»æ± ä¸­è·å–é€šé“
	ch := <-connPool.pool
	// ç¡®ä¿æ— è®ºå‘ç”Ÿä»€ä¹ˆéƒ½å°†é€šé“æ”¾å›æ± ä¸­
	defer func() {
		connPool.pool <- ch
	}()

	// ä½¿ç”¨é€šé“å‘å¸ƒæ¶ˆæ¯åˆ°äº¤æ¢æœº
	err := ch.Publish(
		consts.MQExchangeName, // äº¤æ¢æœºåç§°
		consts.MQRoutingKey,   // è·¯ç”±é”® - ä¸é˜Ÿåˆ—ç»‘å®šé”®åŒ¹é…
		false,                 // mandatory: å¦‚æœä¸ºtrueï¼Œæ‰¾ä¸åˆ°è·¯ç”±æ—¶è¿”å›é”™è¯¯
		false,                 // immediate: RabbitMQå·²å¼ƒç”¨(è®¾ç½®ä¸ºfalse)
		amqp.Publishing{ // æ¶ˆæ¯å±æ€§
			ContentType: "text/plain", // å†…å®¹ç±»å‹
			Body:        message,      // æ¶ˆæ¯ä½“(byteåˆ‡ç‰‡)
		},
	)
	return err // è¿”å›å¯èƒ½çš„é”™è¯¯
}
func StartDLXConsumer() {
	ch := GetChannel()
	defer ReleaseChannel(ch)

	msgs, err := ch.Consume(
		consts.MQDeadLetterQueueName,
		"dlx_consumer",
		false, // æ‰‹åŠ¨ACK
		false,
		false,
		false,
		nil)
	failOnError(err, "Failed to start DLX consumer")

	go func() {
		for d := range msgs {
			log.Printf("æ­»ä¿¡å‘Šè­¦: ä»»åŠ¡ %s è¿›å…¥DLQ, åŸå§‹è·¯ç”±é”®=%s, é”™è¯¯åŸå› =%v",
				d.Body,
				d.RoutingKey,
				d.Headers["x-death"]) // RabbitMQè‡ªåŠ¨æ·»åŠ çš„æ­»äº¡è®°å½•

			// å®é™…é¡¹ç›®ä¸­æ­¤å¤„æ·»åŠ å‘Šè­¦é€šçŸ¥ï¼ˆé‚®ä»¶/é’‰é’‰ç­‰ï¼‰
			// alertService.Notify("æ­»ä¿¡å‘Šè­¦", string(d.Body))

			d.Ack(false) // ç¡®è®¤æ¶ˆè´¹
		}
	}()
	log.Println("æ­»ä¿¡é˜Ÿåˆ—ç›‘å¬å™¨å·²å¯åŠ¨")
}
serviceï¼š
package service

import (
	"backend/internal/api/siliconflowapi/siliconflow"
	"backend/internal/consts"
	"backend/internal/ecode"
	"backend/internal/model/entity"
	"backend/internal/model/request/iTask"
	iTaskRes "backend/internal/model/response/iTask"
	"backend/internal/repository"
	"backend/pkg/mq"
	"errors"
	"fmt"
	"github.com/panjf2000/ants/v2"
	"log"
	"strconv"
	"strings"
	"sync"
	"time"
)

type ITaskService struct {
	ITaskRepo *repository.ITaskRepository
}

func NewITaskService() *ITaskService {
	return &ITaskService{
		ITaskRepo: repository.NewITaskRepository(),
	}
}

var aiGenPool *ants.Pool
var aiGenPoolOnce sync.Once

// ä¿è¯åªåˆå§‹åŒ–ä¸€æ¬¡è°¢æ™¨æ± 
func GetAiGenPool() *ants.Pool {
	aiGenPoolOnce.Do(func() {
		var err error
		aiGenPool, err = ants.NewPool(4,
			ants.WithMaxBlockingTasks(20),
			ants.WithPreAlloc(true),
			ants.WithNonblocking(true))
		if err != nil {
			panic(fmt.Sprintf("åˆ›å»ºåç¨‹æ± å¤±è´¥: %v", err))
		}
	})
	return aiGenPool
}

// åå°åç¨‹ï¼Œè´Ÿè´£å¤„ç†AIå›¾ç‰‡æ‹“å±•ä»»åŠ¡
// åå°åç¨‹ï¼Œè´Ÿè´£å¤„ç†AIå›¾ç‰‡æ‹“å±•ä»»åŠ¡
func OutPaintingBackgroundService() {
	log.Println("å¯åŠ¨å¤–ç»˜èƒŒæ™¯æœåŠ¡...")
	aiPool := GetAiGenPool()
	ch := mq.GetChannel()
	defer mq.ReleaseChannel(ch)

	log.Printf("è¿æ¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—: %s", consts.MQOutPaintingQueueName)
	msgs, err := ch.Consume(
		consts.MQOutPaintingQueueName,
		consts.OutPaintingConsumerName,
		false, // æ‰‹åŠ¨ACK
		false, // éæ’ä»–
		false, // éé˜»å¡
		false, // ä¸ç­‰å¾…
		nil,   // é¢å¤–å‚æ•°
	)
	if err != nil {
		log.Panicf("æ³¨å†Œæ¶ˆè´¹è€…å¤±è´¥: %v", err)
	}
	log.Printf("æˆåŠŸæ³¨å†Œæ¶ˆè´¹è€…: %s", consts.OutPaintingConsumerName)

	type TaskErr struct {
		Id  uint64
		Err error
	}

	errChan := make(chan TaskErr, 24)
	go func() {
		log.Println("å¯åŠ¨é”™è¯¯å¤„ç†åç¨‹...")
		for chanerr := range errChan {
			log.Printf("[ä»»åŠ¡ %d] å¼€å§‹å¤„ç†é”™è¯¯: %v", chanerr.Id, chanerr.Err)

			taskSvc := NewITaskService()
			iTask, err := taskSvc.ITaskRepo.FindById(nil, chanerr.Id)
			if err != nil {
				log.Printf("[ä»»åŠ¡ %d] è·å–ä»»åŠ¡å¤±è´¥: %v", chanerr.Id, err)
				continue
			}
			if iTask == nil {
				log.Printf("[ä»»åŠ¡ %d] ä»»åŠ¡ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤„ç†", chanerr.Id)
				continue
			}

			log.Printf("[ä»»åŠ¡ %d] æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå¤±è´¥", chanerr.Id)
			updateMap := map[string]interface{}{
				"status":       consts.TaskStatusFailed,
				"exec_message": chanerr.Err.Error(),
			}

			err = taskSvc.ITaskRepo.UpdateByMap(nil, iTask.ID, updateMap)
			if err != nil {
				log.Printf("[ä»»åŠ¡ %d] æ›´æ–°ä»»åŠ¡çŠ¶æ€å¤±è´¥: %v", chanerr.Id, err)
			} else {
				log.Printf("[ä»»åŠ¡ %d] ä»»åŠ¡çŠ¶æ€å·²æ›´æ–°ä¸ºå¤±è´¥", chanerr.Id)
			}
		}
	}()

	// å¯åŠ¨æ­»ä¿¡é˜Ÿåˆ—æ¶ˆè´¹è€…
	go mq.StartDLXConsumer()

	go func() {
		log.Println("å¯åŠ¨æ¶ˆæ¯å¤„ç†åç¨‹...")
		for d := range msgs {
			taskId, _ := strconv.ParseUint(string(d.Body), 10, 64)
			log.Printf("[ä»»åŠ¡ %d] æ¥æ”¶åˆ°æ–°ä»»åŠ¡æ¶ˆæ¯", taskId)

			taskProcessErr := aiPool.Submit(func() {
				log.Printf("[ä»»åŠ¡ %d] ä»»åŠ¡å¼€å§‹å¤„ç†", taskId)
				startTime := time.Now()

				taskSvc := NewITaskService()

				iTask, err := taskSvc.ITaskRepo.FindById(nil, taskId)
				if err != nil {
					log.Printf("[ä»»åŠ¡ %d] è·å–ä»»åŠ¡å¤±è´¥: %v", taskId, err)
					d.Nack(false, true) // å¯æ¢å¤é”™è¯¯ï¼Œé‡æ–°å…¥é˜Ÿ
					return
				}
				if iTask == nil {
					log.Printf("[ä»»åŠ¡ %d] ä»»åŠ¡ä¸å­˜åœ¨ï¼Œç›´æ¥ACK", taskId)
					d.Ack(false)
					return
				}

				log.Printf("[ä»»åŠ¡ %d] å½“å‰çŠ¶æ€: %s", taskId, iTask.Status)
				if iTask.Status == consts.TaskStatusSucceed {
					log.Printf("[ä»»åŠ¡ %d] ä»»åŠ¡å·²å®Œæˆï¼Œç›´æ¥ACK", taskId)
					d.Ack(false)
					return
				}

				if iTask.Status == consts.TaskStatusRunning {
					log.Printf("[ä»»åŠ¡ %d] ä»»åŠ¡çŠ¶æ€å¼‚å¸¸: å·²åœ¨è¿è¡Œä¸­", taskId)
					errChan <- TaskErr{
						Id:  iTask.ID,
						Err: errors.New("ä»»åŠ¡å¤„ç†çŠ¶æ€å¼‚å¸¸"),
					}
					d.Ack(false)
					return
				}

				log.Printf("[ä»»åŠ¡ %d] æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºè¿è¡Œä¸­", taskId)
				updateMap := map[string]interface{}{
					"status":       consts.TaskStatusRunning,
					"exec_message": "æ­£åœ¨æ‰§è¡Œ",
				}
				err = taskSvc.ITaskRepo.UpdateByMap(nil, iTask.ID, updateMap)
				if err != nil {
					log.Printf("[ä»»åŠ¡ %d] æ›´æ–°ä»»åŠ¡çŠ¶æ€å¤±è´¥: %v", taskId, err)
					errChan <- TaskErr{
						Id:  iTask.ID,
						Err: fmt.Errorf("æ›´æ–°ä»»åŠ¡çŠ¶æ€å¤±è´¥: %w", err),
					}
					d.Ack(false)
					return
				}
				log.Printf("[ä»»åŠ¡ %d] ä»»åŠ¡çŠ¶æ€å·²æ›´æ–°ä¸ºè¿è¡Œä¸­", taskId)

				log.Printf("[ä»»åŠ¡ %d] å¼€å§‹è°ƒç”¨AIå¤„ç†", taskId)
				result, err := taskSvc.processTask(iTask)
				if err != nil {
					// åˆ¤æ–­é”™è¯¯ç±»å‹ï¼Œå†³å®šæ˜¯é‡æ–°å…¥é˜Ÿè¿˜æ˜¯è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—
					if isRecoverableError(err) {
						log.Printf("[ä»»åŠ¡ %d] å¯æ¢å¤é”™è¯¯ï¼Œé‡æ–°å…¥é˜Ÿ: %v", taskId, err)
						d.Nack(false, true) // é‡æ–°å…¥é˜Ÿé‡è¯•
					} else {
						log.Printf("[ä»»åŠ¡ %d] ä¸å¯æ¢å¤é”™è¯¯ï¼Œè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—: %v", taskId, err)
						d.Nack(false, false) // è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—
					}
					errChan <- TaskErr{
						Id:  iTask.ID,
						Err: fmt.Errorf("AIå¤„ç†å¤±è´¥: %w", err),
					}
					return
				}
				log.Printf("[ä»»åŠ¡ %d] AIå¤„ç†æˆåŠŸå®Œæˆ", taskId)

				log.Printf("[ä»»åŠ¡ %d] æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºæˆåŠŸ", taskId)
				updateMap = map[string]interface{}{
					"status":           consts.TaskStatusSucceed,
					"exec_message":     "æ‰§è¡ŒæˆåŠŸ",
					"expanded_pic_url": result.DirectURL,
					"ai_recap":         result.Analysis,
				}

				err = taskSvc.ITaskRepo.UpdateByMap(nil, iTask.ID, updateMap)
				if err != nil {
					log.Printf("[ä»»åŠ¡ %d] ä¿å­˜ä»»åŠ¡ç»“æœå¤±è´¥: %v", taskId, err)
					errChan <- TaskErr{
						Id:  iTask.ID,
						Err: fmt.Errorf("ä¿å­˜ä»»åŠ¡ç»“æœå¤±è´¥: %w", err),
					}
					d.Ack(false)
					return
				}

				duration := time.Since(startTime)
				log.Printf("[ä»»åŠ¡ %d] ä»»åŠ¡å¤„ç†æˆåŠŸå®Œæˆ! è€—æ—¶: %v", taskId, duration)
				d.Ack(false)
			})

			if taskProcessErr != nil {
				log.Printf("[ä»»åŠ¡ %d] ä»»åŠ¡æäº¤åˆ°åç¨‹æ± å¤±è´¥: %v", taskId, taskProcessErr)
				d.Nack(false, true)
			} else {
				log.Printf("[ä»»åŠ¡ %d] ä»»åŠ¡å·²æˆåŠŸæäº¤åˆ°åç¨‹æ± ", taskId)
			}
		}
	}()

	log.Println("å¤–ç»˜æœåŠ¡å¯åŠ¨ï¼Œæ­»ä¿¡ç›‘å¬å·²æ¿€æ´»")
}

// åˆ¤æ–­é”™è¯¯æ˜¯å¦å¯æ¢å¤
func isRecoverableError(err error) bool {
	
}

// åœ¨serviceå±‚å¤„ç†ä»»åŠ¡
func (s *ITaskService) processTask(iTask *entity.ITask) (*siliconflow.OutPaintingResult, error) {
	// è°ƒç”¨AI API
	response, err := siliconflow.OutPaintingAPI(
		iTask.Prompt,
		iTask.OriginalPicUrl,
	)

	if err != nil {
		return nil, fmt.Errorf("AIå¤„ç†å¤±è´¥: %w", err)
	}

	// ç¡®ä¿æœ‰è¿”å›ç»“æœ
	if len(response.Choices) == 0 || response.Choices[0].Message.Content == "" {
		return nil, errors.New("AIè¿”å›ç»“æœä¸ºç©º")
	}

	// è§£æç‰¹å®šæ ¼å¼çš„AIå“åº”
	return siliconflow.ParseOutPaintingResult(response.Choices[0].Message.Content)
}

// ä¿®å¤1: å®ç°åŸProCreatePictureOutPaintingTaskåŠŸèƒ½
func (s *ITaskService) ProCreatePictureOutPaintingTask(req *iTask.TaskRequest, userId uint64) *ecode.ErrorWithCode {
	task := entity.ITask{
		Name:           "",
		Prompt:         req.Prompt,
		OriginalPicUrl: req.ImageURL,
		ExpandParams:   "{}",
		Status:         consts.TaskStatusWait,
		UserID:         userId,
	}

	if err := s.ITaskRepo.Create(nil, &task); err != nil {
		return ecode.GetErrWithDetail(ecode.SYSTEM_ERROR, "æ•°æ®åº“é”™è¯¯")
	}

	// å‘é€MQæ¶ˆæ¯
	s.sendToMQ(&task)
	return nil
}

// ä¿®å¤2: å®ç°GetITaskVOListåŠŸèƒ½
func (s *ITaskService) GetITaskVOList(userId uint64) ([]iTaskRes.ITaskVO, *ecode.ErrorWithCode) {
	tasks, err := s.ITaskRepo.FindByUserId(nil, userId)
	if err != nil {
		return nil, ecode.GetErrWithDetail(ecode.SYSTEM_ERROR, "æ•°æ®åº“é”™è¯¯")
	}

	vos := make([]iTaskRes.ITaskVO, 0, len(tasks))
	for _, task := range tasks {
		vos = append(vos, iTaskRes.ITaskVO{
			ID:             task.ID,
			Name:           task.Name,
			OriginalPicUrl: task.OriginalPicUrl,
			ExpandedPicUrl: task.ExpandedPicUrl,
			Status:         task.Status,
			CreateTime:     task.CreateTime,
		})
	}
	return vos, nil
}

// ä¿®å¤5: å®ç°DeleteImageExpandTaskåŠŸèƒ½
func (s *ITaskService) DeleteImageExpandTask(id uint64) *ecode.ErrorWithCode {
	err := s.ITaskRepo.Delete(nil, id)
	if err != nil {
		return ecode.GetErrWithDetail(ecode.SYSTEM_ERROR, "æ•°æ®åº“é”™è¯¯")
	}
	return nil
}
func (s *ITaskService) sendToMQ(task *entity.ITask) {
	// è·å–MQè¿æ¥æ± 
	pool := mq.GetChannelPool()

	// å°†ä»»åŠ¡IDè½¬æ¢ä¸ºæ¶ˆæ¯ä½“
	message := []byte(strconv.FormatUint(task.ID, 10))

	// å‘å¸ƒæ¶ˆæ¯åˆ°RabbitMQ
	if err := pool.PublishMessage(message); err != nil {
		log.Printf("MQæ¶ˆæ¯å‘é€å¤±è´¥! ä»»åŠ¡ID: %d, é”™è¯¯: %v", task.ID, err)

		// å¦‚æœæ¶ˆæ¯å‘é€å¤±è´¥ï¼Œå›æ»šä»»åŠ¡çŠ¶æ€ä¸º"ç­‰å¾…"
		updateMap := map[string]interface{}{
			"status":       consts.TaskStatusWait,
			"exec_message": "MQå‘é€å¤±è´¥ï¼Œç­‰å¾…é‡è¯•",
		}

		_ = s.ITaskRepo.UpdateByMap(nil, task.ID, updateMap)
	} else {
		log.Printf("MQæ¶ˆæ¯æˆåŠŸå‘é€! ä»»åŠ¡ID: %d", task.ID)
	}
}

```

è¡¥å……ï¼šå¤šç»´æœç´¢ï¼Œå‡å°‘å†—ä½™ä»£ç ï¼š

```go
func ProListPictureVOByPageWithCache(c *gin.Context) {
    	queryReq := reqPicture.PictureQueryRequest{}

}
|
func (s *PictureService) ListPictureByPage
|
// è·å–ä¸€ä¸ªé“¾å¼æŸ¥è¯¢å¯¹è±¡
func (s *PictureService) GetQueryWrapper(db *gorm.DB, req *reqPicture.PictureQueryRequest) (*gorm.DB, *ecode.ErrorWithCode) {
	query := db.Session(&gorm.Session{})
	if req.SearchText != "" {
		query = query.Where("name LIKE ? OR introduction LIKE ?", "%"+req.SearchText+"%", "%"+req.SearchText+"%")
	}
	if req.ID != 0 {
		query = query.Where("id = ?", req.ID)
	}
	if req.UserID != 0 {
		query = query.Where("user_id = ?", req.UserID)
	}
	if req.Name != "" {
		query = query.Where("name LIKE ?", "%"+req.Name+"%")
	}
	if req.Introduction != "" {
		query = query.Where("introduction LIKE ?", "%"+req.Introduction+"%")
	}
	if req.PicFormat != "" {
		query = query.Where("pic_format LIKE ?", "%"+req.PicFormat+"%")
	}
	if req.Category != "" {
		query = query.Where("category = ?", req.Category)
	}
	if req.PicWidth != 0 {
		query = query.Where("pic_width = ?", req.PicWidth)
	}
	if req.PicHeight != 0 {
		query = query.Where("pic_height = ?", req.PicHeight)
	}
	if req.PicSize != 0 {
		query = query.Where("pic_size = ?", req.PicSize)
	}
	if req.PicScale != 0 {
		query = query.Where("pic_scale = ?", req.PicScale)
	}
	//è¡¥å……å®¡æ ¸å­—æ®µæ¡ä»¶
	if req.ReviewStatus != nil {
		query = query.Where("review_status = ?", *req.ReviewStatus)
	}
	if req.ReviewMessage != "" {
		query = query.Where("review_message LIKE ?", "%"+req.ReviewMessage+"%")
	}
	if req.ReviewerID != 0 {
		query = query.Where("reviewer_id = ?", req.ReviewerID)
	}
	if req.SpaceID != 0 {
		query = query.Where("space_id = ?", req.SpaceID)
	}
	if req.IsNullSpaceID {
		query = query.Where("space_id IS NULL")
	}
	//è¡¥å……æŸ¥è¯¢å›¾ç‰‡çš„ç¼–è¾‘æ—¶é—´ï¼ŒStartEditTime<=æŸ¥æ‰¾å›¾ç‰‡<EndEditTime
	if !req.StartEditTime.IsZero() {
		query = query.Where("edit_time >= ?", req.StartEditTime)
	}
	if !req.EndEditTime.IsZero() {
		query = query.Where("edit_time < ?", req.EndEditTime)
	}
	//tagsåœ¨æ•°æ®åº“ä¸­çš„å­˜å‚¨æ ¼å¼ï¼š["golang","java","c++"]
	if len(req.Tags) > 0 {
		//and (tags LIKE %"commic" and tags LIKE %"manga"% ...)
		for _, tag := range req.Tags {
			query = query.Where("tags LIKE ?", "%\""+tag+"\"%")
		}
	}
	if req.SortField != "" {
		sortOrder := "ASC"
		if req.SortOrder == "descend" {
			sortOrder = "DESC"
		}
		query = query.Order(fmt.Sprintf("%s %s", req.SortField, sortOrder))
	}
	return query, nil
}

```

